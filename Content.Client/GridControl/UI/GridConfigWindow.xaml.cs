using System.Linq;
using System.Resources;
using Content.Shared.Access;
using Content.Shared.Access.Systems;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using static Content.Shared.GridControl.Components.GridConfigComponent;
using static Robust.Client.UserInterface.Controls.BaseButton;

namespace Content.Client.GridControl.UI;
[GenerateTypedNameReferences]
public sealed partial class GridConfigWindow : DefaultWindow
{
    public GridConfigBoundUserInterface? BUI;
    public void OnGridName(ButtonEventArgs args)
    {
        if(GridNameLineEdit.Text != null && GridNameLineEdit.Text != "")
        {
            if (BUI != null)
            {
                BUI.SendMessage(new GridConfigChangeName(GridNameLineEdit.Text));
            }
        }
    }
    public void OnGridDisconnect(ButtonEventArgs args)
    {
        if (BUI != null)
        {
            BUI.SendMessage(new GridConfigDisconnect());
        }
    }

    public void OnGridConnect(ButtonEventArgs args)
    {
        if (BUI != null)
        {
            BUI.SendMessage(new GridConfigConnect());
        }
    }
    public void ChangeMode(ButtonEventArgs args)
    {
        if (BUI != null)
        {
            BUI.SendMessage(new GridConfigChangeMode());
        }
    }
    public GridConfigWindow()
    {
        RobustXamlLoader.Load(this);
        ChangeModeBtn.OnPressed += ChangeMode;

        PossibleTargets.OnItemSelected += OnTargetSelected;
        GridConnect.OnPressed += OnGridConnect;
        GridDisconnect.OnPressed += OnGridDisconnect;
        GridNameBtn.OnPressed += OnGridName;

    }
    private void OnTargetSelected(OptionButton.ItemSelectedEventArgs args)
    {
        if (BUI != null)
        {
            BUI.SendMessage(new GridConfigTargetSelect(args.Id));
        }
    }
    public void UpdateState(IPrototypeManager protoManager, GridConfigBoundUserInterfaceState state)
    {
        if(state.IdPresent)
        {
            PrivilegedIdButton.Text = state.IdName;
        }
        else
        {
            PrivilegedIdButton.Text = "";
        }
        string targetName = "";
        if(state.TargetName != null)
        {
            targetName = state.TargetName; 
        }
        GridTileCount.Text = $"{state.GridTileCount}";
        MaxPersonalClaimTileCount.Text = $"{state.MaxPersonalClaimTileCount- state.CurrentTileCount} available tiles";
        if (state.PersonalMode)
        {
            ChangeModeBtn.Text = "Station";
            PossibleTargets.Visible = false;
            TargetNameLabel.Text = $"Target Person: {targetName}";            
        }
        else
        {
            TargetNameLabel.Text = "Target Station: ";
            ChangeModeBtn.Text = "Personal";
            PossibleTargets.Clear();
            PossibleTargets.Visible = true;
            PossibleTargets.AddItem("None", 0);
            if (state.PossibleStations != null)
            {
                foreach (var kv in state.PossibleStations)
                {
                    PossibleTargets.AddItem(kv.Value, kv.Key);
                    if (kv.Key == state.targetStation)
                    {
                        PossibleTargets.SelectId(kv.Key);
                    }
                }
            }
        }
        bool gridFound = false;
        if(state.GridName != null)
        {
            gridFound = true;
            GridNameLabel.Text = state.GridName;
        }
        else
        {
            GridNameLabel.Text = "*Invalid*";
        }
        bool gridOwned = false;
        if(state.ErrorMessage == null)
        {
            if(state.GridTileCount+state.CurrentTileCount > state.MaxPersonalClaimTileCount)
            {
                state.ErrorMessage = "This grid will exceed the tile limit.";
            }
        }
        if (state.OwnerName != null)
        {
            gridOwned = true;
            GridOwnerLabel.Text = state.OwnerName;
        }
        else
        {
            GridOwnerLabel.Text = "UNCLAIMED";
        }
        if(!gridFound)
        {
            MissingPrivilegesLabel.Text = "No grid detected.";
        }
        else if(!state.IsAuth)
        {
            MissingPrivilegesLabel.Text = "You are not authorized to modify this grid.";
        }
        else if(state.ErrorMessage != null)
        {
            MissingPrivilegesLabel.Text = state.ErrorMessage;
        }
        else
        {
            MissingPrivilegesLabel.Text = "";
        }

        if(state.IsControlled || !gridFound || !gridOwned)
        {
            GridDisconnect.Disabled = true;
        }
        else
        {
            GridDisconnect.Disabled = false;
        }

        if (gridFound && state.IsAuth && state.ErrorMessage == null)
        {
            if (gridOwned)
            {
                GridConnect.Disabled = true;

                GridNameBtn.Disabled = false;
            }
            else
            {
                GridConnect.Disabled = false;
                GridNameBtn.Disabled = true;
            }
        }
        else
        {
            GridConnect.Disabled = true;
            GridNameBtn.Disabled = true;
        }
    }

}
